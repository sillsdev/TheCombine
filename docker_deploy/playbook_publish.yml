---
##############################################################
# Playbook: playbook_combine.yml
#
# Pre-requisites:
#   * run
#       ansible-playbook playbook_docker.yml ...
#     on this target to install the required packages.
#
# playbook_combine.yml does the following:
#   * installs TheCombine source code;
#   * sets up the docker-compose override files to configure
#     TheCombine for the specified target machine
#   * builds the Docker containers for TheCombine
#   * starts TheCombine running
#
##############################################################

- name: Setup TheCombine Using Docker
  hosts: all
  gather_facts: yes
  become: no

  vars_files:
    - "vars/config_common.yml"
    - "vars/packages.yml"
    - "vars/vault_config.yml"

  tasks:
    - name: install TheCombine source files
      import_role:
        name: combine_source
      tags:
        - combine_source

    - name: configure docker containers for TheCombine
      import_role:
        name: combine_containers
      tags:
        - docker_config

    - name: install application presets
      import_role:
        name: combine_init
      tags:
        - init

    - name: start the containers
      command: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up --detach
      args:
        chdir: "{{ source_dir }}"

    - name: install shortcuts
      import_role:
        name: combine_shortcuts
      tags:
        shortcuts
