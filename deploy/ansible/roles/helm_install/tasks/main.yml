---
- name: Create working directory
  file:
    path: "{{ helm_download_dir }}"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Ansible user
  become: false
  debug:
    msg: "Ansible User: {{ ansible_user_id }}"

- name: Get Latest Release
  get_url:
    # https://get.helm.sh/helm-v3.13.2-linux-amd64.tar.gz
    url: "https://get.helm.sh/helm-{{ helm_version }}-{{ helm_arch }}.tar.gz"
    dest: "{{ helm_download_dir }}/helm.tar.gz"
    owner: root
    group: root
    mode: 0755

- name: Unpack helm tarball
  command:
    cmd: "tar -zxvf {{ helm_download_dir }}/helm.tar.gz"
    chdir: "{{ helm_download_dir }}"
    creates: "{{ helm_download_dir }}/{{ helm_arch }}/helm"

- name: Link to extracted helm file
  file:
    src: "{{ helm_download_dir }}/{{ helm_arch }}/helm"
    path: /usr/local/bin/helm
    state: link
    owner: root
    group: root
    mode: 0755

#############################################
# These chart repos get setup for root
# Add the commands to the general installation
# script
- name: Add stable charts
  command:
    cmd: helm repo add stable https://charts.helm.sh/stable

- name: Add bitnami charts
  command:
    cmd: helm repo add bitnami https://charts.bitnami.com/bitnami
