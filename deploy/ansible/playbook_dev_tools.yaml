---
##############################################################
# playbook_dev_tools.yml installs some packages that may be
# useful for developers.  In addition, the apt cache is
# updated and existing packages are upgraded.
##############################################################

- name: Install development tools
  hosts: all
  gather_facts: yes
  become: yes

  vars:
    developer: "{{ k8s_user | default('none') }}"
    developer_group: "{{ k8s_group | default('none') }}"

  tasks:
    - name: Update cache and upgrade existing packages
      apt:
        update_cache: yes
        upgrade: "yes"

    - name: Install packages for development
      apt:
        name:
          - emacs-nox
          - yaml-mode
          - net-tools

    - name: Skip sudo password for {{ developer }}
      template:
        src: sudoer.j2
        dest: /etc/sudoers.d/{{ developer }}
        owner: root
        group: root
        mode: 0440
      when: developer != 'none'

    - name: Print ansible_user
      debug:
        msg: "ansible_user: {{ ansible_facts.ansible_user }}"

    - name: Get home directory for {{ developer }}
      shell: >
        getent passwd {{ developer }} | awk -F: '{ print $6 }'
      register: developer_home
      changed_when: false
      when: developer != 'none'

    - name: Print home directory
      debug:
        msg: "Developer home directory is: {{ developer_home.stdout }}"
      when: developer != 'none'

    - name: Create directory for terminal profiles
      file:
        state: directory
        path: "{{ developer_home.stdout }}/.config/user-terminal-prefs"
        owner: "{{ developer }}"
        group: "{{ developer_group }}"
        mode: 0755
      when: developer != 'none'

    - name: Copy gnome-terminal profiles
      copy:
        src: gnome-terminal-profiles.dconf
        dest: "{{ developer_home.stdout }}/.config/user-terminal-prefs/gnome-terminal-profiles.dconf"
        owner: "{{ developer }}"
        group: "{{ developer_group }}"
        mode: 0644
      when:
        - developer != 'none'
        - developer_group != 'none'

    - name: Create ~/.local/bin
      file:
        state: directory
        path: "{{ developer_home.stdout }}/.local/bin"
        mode: 0755
      when: developer != 'none'

    - name: Copy script to install terminal profiles
      copy:
        src: install-terminal-profiles.sh
        dest: "{{ developer_home.stdout }}/.local/bin/install-terminal-profiles"
        owner: "{{ developer }}"
        group: "{{ developer_group }}"
        mode: 0755
      when: developer != 'none'
