---
- name: Install pre-requisite packages
  apt:
    name: "{{ k8s_required_pkgs }}"

# configure kubernetes user
- name: adding existing user '{{ k8s_user }}' to group docker
  user:
    name: "{{ k8s_user }}"
    groups: docker
    append: yes

- name: Install Kubernetes Engine
  include_tasks:
    file: "{{ k8s_engine }}.yml"
  when: k8s_engine != "none"

- name: Download the Google Cloud public signing key
  get_url:
    dest: /usr/share/keyrings/kubernetes-archive-keyring.gpg
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg

- name: Add repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"
    filename: kubernetes

- name: Install kubectl
  apt:
    name: kubectl

- name: NGINX Ingress Controller
  delegate_to: localhost
  become: no
  block:
    - name: Check for nginx ingress controller namespace
      command: >
        kubectl --kubeconfig={{ kubecfg }}
        get namespace {{ ingress_namespace }}
      register: check_nginx_ns
      failed_when: false
      changed_when: false

    - name: Create ingress controller namespace
      command: >
        kubectl --kubeconfig={{ kubecfg }}
        create namespace {{ ingress_namespace }}
      when: check_nginx_ns.rc != 0

    - name: Add NGINX ingress controller helm repo
      command: >
        helm --kubeconfig={{ kubecfg }}
        repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
      register: result

    - name: Update the repo
      command: helm --kubeconfig={{ kubecfg }} repo update
      when: result.stdout.find('has been added') != -1

    - name: Check if nginx ingress controller is installed
      command: >
        kubectl --kubeconfig={{ kubecfg }}
        -n {{ ingress_namespace }}
        get deployment/ingress-controller-ingress-nginx-controller
      register: check_nginx_deployment
      failed_when: false
      changed_when: false

    - name: Install the nginx-ingress helm package
      command: >
        helm --kubeconfig={{ kubecfg }}
        install ingress-controller
        ingress-nginx/ingress-nginx
        --namespace {{ ingress_namespace }}
      when: check_nginx_deployment.rc != 0
  when: '"ingress_controller" in k8s_components'
