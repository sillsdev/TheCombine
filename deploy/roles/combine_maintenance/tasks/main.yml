---
#######################################################
#
# Install and configure the backup script for the docker
# containers

- name: install required Python packages
  pip:
    name: humanfriendly
    state: present

- name: create folder for scripts
  file:
    name: "{{ combine_app_dir }}/bin"
    owner: "{{ combine_user }}"
    group: "{{ combine_group }}"
    mode: 0755
    state: directory

- name: clean out deprecated scripts
  file:
    name: "{{ combine_app_dir }}/bin/{{ item }}"
    state: absent
  with_items:
    - combine-backup
    - combine-restore
    - combine-env
    - backup_conf.json

- name: install backup/restore scripts
  template:
    src: "{{ item.name }}.j2"
    dest: "{{ combine_app_dir }}/bin/{{ item.name }}"
    owner: "{{ combine_user }}"
    group: "{{ combine_group }}"
    mode: "{{ item.mode }}"
  with_items:
    - name: combine-clean-aws
      mode: "0755"
    - name: combine-backup-job
      mode: "0755"
    - name: script_conf.json
      mode: "0644"

- name: install additional maintenance scripts
  copy:
    src: "{{ item.name }}"
    dest: "{{ combine_app_dir }}/bin/{{ item.name }}"
    owner: "{{ combine_user }}"
    group: "{{ combine_group }}"
    mode: "{{ item.mode }}"
  with_items:
    - name: add_user_to_proj.py
      mode: "0755"
    - name: aws_backup.py
      mode: "0644"
    - name: combine_app.py
      mode: "0644"
    - name: combine_backup.py
      mode: "0755"
    - name: combine_restore.py
      mode: "0755"
    - name: maint_utils.py
      mode: "0644"
    - name: make_user_admin.py
      mode: "0755"
    - name: rm_project.py
      mode: "0755"
    - name: script_step.py
      mode: "0644"

- name: set environment variables for backup job
  cron:
    env: yes
    user: "{{ combine_user }}"
    name: MAX_BACKUPS
    value: "{{ max_backups }}"
  when:
    - backup_hour is defined
    - backup_minute is defined

- name: schedule regular backups
  cron:
    name: combine daily backup
    job: "{{ combine_app_dir }}/bin/combine-backup-job  2>&1 | /usr/bin/logger -t combine_backup"
    user: "{{ combine_user }}"
    hour: "{{ backup_hour }}"
    minute: "{{ backup_minute }}"
  when:
    - backup_hour is defined
    - backup_minute is defined
