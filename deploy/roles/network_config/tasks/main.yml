---
##################################
# Update the netplan configuration files
# for the ethernet interface to mark it
# as optional
##################################

- name: List netplan configuration files
  find:
    paths: /etc/netplan
    patterns: "*.yaml"
  when: eth_optional
  register: net_config

- name: Set Ethernet I/F as optional
  lineinfile:
    path: "{{ item.path }}"
    state: present
    insertafter: "^    en[a-z]\\d"
    line: "      optional: true"
  when: eth_optional
  with_items: "{{ net_config.files }}"
  notify: Apply netplan

- name: Configure resolv.conf to use {{ ap_gateway }} as DNS nameserver
  template:
    src: resolved.conf.j2
    dest: /etc/systemd/resolved.conf
    owner: root
    group: root
    mode: 0644
  notify: Restart resolved
  when: has_wifi
