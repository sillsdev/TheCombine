apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: daily-backup
  namespace: {{ app_namespace }}
spec:
  concurrencyPolicy: Allow
  failedJobsHistoryLimit: 1
  jobTemplate:
    metadata:
      creationTimestamp: null
    spec:
      ttlSecondsAfterFinished: 300
      template:
        metadata:
          creationTimestamp: null
        spec:
          containers:
          - image: '{{ combine_image_maintenance }}'
{% if image_tag == "latest" %}
            imagePullPolicy: Always
{% else %}
            imagePullPolicy: IfNotPresent
{% endif %}
            name: daily-backup
            volumeMounts:
              - name: cluster-kubeconfig
                mountPath: /home/user/.kube
            command:
              - combine-backup-job.sh
            env:
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    key: AWS_ACCESS_KEY_ID
                    name: aws-s3-credentials
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    key: AWS_SECRET_ACCESS_KEY
                    name: aws-s3-credentials
              - name: AWS_ACCOUNT
                valueFrom:
                  secretKeyRef:
                    key: AWS_ACCOUNT
                    name: aws-s3-credentials
              - name: AWS_DEFAULT_REGION
                valueFrom:
                  secretKeyRef:
                    key: AWS_DEFAULT_REGION
                    name: aws-s3-credentials
              - name: aws_bucket
                valueFrom:
                  configMapKeyRef:
                    key: aws_bucket
                    name: env-maintenance
              - name: db_files_subdir
                valueFrom:
                  configMapKeyRef:
                    key: db_files_subdir
                    name: env-maintenance
              - name: backend_files_subdir
                valueFrom:
                  configMapKeyRef:
                    key: backend_files_subdir
                    name: env-maintenance
              - name: combine_host
                valueFrom:
                  configMapKeyRef:
                    key: combine_host
                    name: env-maintenance
              - name: wait_time
                valueFrom:
                  configMapKeyRef:
                    key: wait_time
                    name: env-maintenance
              - name: max_backups
                valueFrom:
                  configMapKeyRef:
                    key: max_backups
                    name: env-maintenance
              - name: backup_filter
                valueFrom:
                  configMapKeyRef:
                    key: backup_filter
                    name: env-maintenance

            resources: {}
            securityContext:
              capabilities: {}
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
{% if image_pull_secret is defined and image_pull_secret | length %}
          imagePullSecrets:
             - name: {{ image_pull_secret }}
{% endif %}
          dnsPolicy: Default
          restartPolicy: Never
          schedulerName: default-scheduler
          terminationGracePeriodSeconds: 30
          volumes:
            - name: cluster-kubeconfig
              secret:
                secretName: "{{ k8s_config_secret }}"
  schedule: "{{ combine_backup_schedule }}"
  successfulJobsHistoryLimit: 1
  suspend: false
