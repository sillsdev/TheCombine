apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: daily-backup
  namespace: {{ app_namespace }}
spec:
  concurrencyPolicy: Allow
  failedJobsHistoryLimit: 1
  jobTemplate:
    metadata:
      creationTimestamp: null
    spec:
      ttlSecondsAfterFinished: 300
      template:
        metadata:
          creationTimestamp: null
        spec:
          serviceAccountName: {{ k8s_service_accounts.maintenance }}
          containers:
          - image: sillsdev/aws-kubectl:0.1.9
            imagePullPolicy: Always
            name: daily-backup
            command:
              - kubectl
            args:
              - -n
              - thecombine
              - exec
              - deployment/maintenance
              - --
              - combine-backup-job.sh
            resources: {}
            securityContext:
              capabilities: {}
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
{% if image_pull_secret is defined and image_pull_secret | length %}
          imagePullSecrets:
             - name: {{ image_pull_secret }}
{% endif %}
          dnsPolicy: Default
          restartPolicy: Never
          schedulerName: default-scheduler
          terminationGracePeriodSeconds: 30
  schedule: "{{ combine_backup_schedule }}"
  successfulJobsHistoryLimit: 1
  suspend: false
