---
- name: Print combine configuration directory
  debug:
    var: k8s_combine_cfg

- name: Create directory for The Combine configuration files
  file:
    path: "{{ k8s_combine_cfg }}"
    state: directory
    mode: 0700

- name: Create Kubernetes patch files for backend and frontend
  template:
    src: "{{ item }}.j2"
    dest: "{{ k8s_combine_cfg }}/{{ item }}"
    mode: 0600
  with_items:
    - patch-backend.yaml
    - patch-frontend.yaml

- name: Apply Kubernetes configuration
  command: >
    kubectl --kubeconfig={{ kubecfg }} patch deployment
    {{ item.deployment }} --patch-file
    {{ k8s_combine_cfg }}/{{ item.patch }}
  args:
    chdir: "{{ k8s_working_dir }}"
  with_items:
    - deployment: backend
      patch: patch-backend.yaml
    - deployment: frontend
      patch: patch-frontend.yaml
