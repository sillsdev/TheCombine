---
- name: Create The Combine Configuration Files
  delegate_to: localhost
  become: no
  block:
    - name: Create directory for The Combine configuration files
      file:
        path: "{{ k8s_combine_cfg }}"
        state: directory
        mode: 0700

    - name: Create Kubernetes configuration files
      template:
        src: "{{ item }}"
        dest: "{{ k8s_combine_cfg }}/{{ item | basename | regex_replace('^(.*\\.yaml)\\.j2', '\\1') }}"
        mode: 0600
      with_fileglob:
        - "templates/*.yaml.j2"

    # - name: Print config command
    #   debug:
    #     msg: "kubectl --kubeconfig=kubeconfig apply -f {{ item }}"
    #   with_items: "{{ lookup('fileglob', '{{ k8s_combine_cfg }}/*.yaml').split(',') | sort }}"
    #
    - name: Apply Kubernetes configuration
      command: kubectl --kubeconfig=kubeconfig apply -f {{ item }}
      args:
        chdir: "{{ k8s_working_dir }}"
      with_items: "{{ lookup('fileglob', '{{ k8s_combine_cfg }}/*.yaml').split(',') | sort }}"
