---
- name: Test if aws-ecr-credential manager is installed
  command: kubectl --kubeconfig=kubeconfig -n {{ app_namespace }} get secrets aws-registry
  args:
    chdir: "{{ k8s_working_dir }}"
  register: aws_mgr_installed
  changed_when: false
  failed_when: false

- name: Print aws_mgr_installed results
  debug:
    var: aws_mgr_installed

- name: Install aws-ecr-credential manager repo
  command: helm repo add architectminds https://architectminds.github.io/helm-charts/
  args:
    chdir: "{{ k8s_working_dir }}"
  when: aws_mgr_installed.rc != 0

- name: Install aws-ecr-credential manager
  command: >
    helm --kubeconfig kubeconfig install aws-ecr-credential
    architectminds/aws-ecr-credential
    --set-string aws.account={{ aws_account }}
    --set aws.region={{ aws_region }}
    --set aws.accessKeyId="{{ aws_access_profiles.ecr_read_only.key_id | b64encode }}"
    --set aws.secretAccessKey="{{ aws_access_profiles.ecr_read_only.secret | b64encode }}"
    --set targetNamespace={{ app_namespace }}
  args:
    chdir: "{{ k8s_working_dir }}"
  when: aws_mgr_installed.rc != 0
