---
- name: Install aws-ecr-credential manager
  delegate_to: localhost
  become: no
  block:
    - name: Test if aws-ecr-credential manager is installed
      command: kubectl --kubeconfig=kubeconfig -n {{ app_namespace }} get secrets aws-registry
      register: aws_mgr_installed
      changed_when: false
      failed_when: false

    - name: Install aws-ecr-credential manager repo
      command: helm3 repo add architectminds https://architectminds.github.io/helm-charts/
      when: aws_mgr_installed.rc != 0

    - name: Install aws-ecr-credential manager
      command: >
        helm3 install aws-ecr-credential 
        architectminds/aws-ecr-credential
        --set-string aws.account={{ aws_account }}
        --set aws.region={{ aws_region }}
        --set aws.accessKeyId=""
        --set aws.secretAccessKey=""
        --set targetNamespace={{ app_namespace }}
