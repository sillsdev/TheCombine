---
- name: Test if aws-ecr-credential manager is installed
  command: kubectl --kubeconfig={{ kubecfg }} -n {{ app_namespace }} get secrets aws-registry
  register: aws_mgr_installed
  changed_when: false
  failed_when: false

- name: Install aws-ecr-credential manager repo
  command: helm repo add architectminds https://architectminds.github.io/helm-charts/
  when: aws_mgr_installed.rc != 0

- name: Install aws-ecr-credential manager
  delegate_to: localhost
  command: >
    helm install aws-ecr-credential
    architectminds/aws-ecr-credential
    --set-string aws.account={{ aws_account }}
    --set aws.region={{ aws_region }}
    --set aws.accessKeyId="{{ aws_access_profiles.ecr_read_only.key_id | b64encode }}"
    --set aws.secretAccessKey="{{ aws_access_profiles.ecr_read_only.secret | b64encode }}"
    --set targetNamespace={{ app_namespace }}
  when: aws_mgr_installed.rc != 0
