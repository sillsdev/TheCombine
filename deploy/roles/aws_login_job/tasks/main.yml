---
- name: Create directory for the AWS Login cron job files
  file:
    path: "{{ k8s_aws_login_cfg }}"
    state: directory
    mode: 0700

##############################################################
# Delete any immutable objects leftover from previous runs
##############################################################
- name: Delete residual resources
  command: >
    kubectl --kubeconfig={{ kubecfg }} -n {{ aws_namespace }}
    delete {{ item.resource }} --ignore-not-found {{ item.name }}
  loop:
    - name: "{{ aws_ecr_login.job_name }}"
      resource: job
    - name: "{{ aws_ecr_login.secrets_name }}"
      resource: secret

##############################################################
# AWS login resources as specified in aws_ecr_login.config_files
# May include
# - AWS credentials secret
# - One-shot job to get AWS Login
# - cron job to keep login fresh
##############################################################
- name: Create AWS login resources
  import_role:
    name: k8s_make_resources
  vars:
    parent_name: aws_login_job/Create AWS login resources
    k8s_config_dir: "{{ k8s_aws_login_cfg }}"
    k8s_templates:
      - aws-login-config.yaml
      - aws-access-secrets.yaml
      - aws-ecr-login-oneshot.yaml

##############################################################
# Create cron job to refresh AWS login credentials if
# specified, that is, aws_ecr_login.cron is true
##############################################################
- name: Create AWS login cron job
  import_role:
    name: k8s_make_resources
  vars:
    parent_name: aws_login_job/Create AWS login cron job
    k8s_config_dir: "{{ k8s_aws_login_cfg }}"
    k8s_templates:
      - aws-ecr-login-cronjob.yaml
  when: aws_ecr_login.cron
