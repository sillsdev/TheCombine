---
##############################################################
#
# This role creates a job to setup the site admin user
# for the Combine.  It assumes that the Combine's services
# have been installed and are running, specifically:
#  - deployment/database
#  - service/database
#  - configmap/env-backend
#  - secret/env-backend-secrets
#
##############################################################

##############################################################
# Delete any immutable objects leftover from previous runs
##############################################################
- name: Delete residual resources
  command: >
    kubectl --kubeconfig={{ kubecfg }} -n {{ app_namespace }}
    delete job --ignore-not-found {{ admin_user_job_name }}

- name: Create Job to create 'admin' user
  import_role:
    name: k8s_make_resources
  vars:
    parent_name: k8s_admin_user
    k8s_config_dir: "{{ k8s_admin_cfg }}"
    k8s_templates:
      - admin-user-secrets.yaml
      - job-create-admin-user.yaml

- name: Wait for job to complete
  command: kubectl --kubeconfig={{ kubecfg }} -n {{ app_namespace }} wait --for=condition=complete job/{{ admin_user_job_name }}
  register: results_create_admin

- name: Delete admin login secret
  command: kubectl --kubeconfig={{ kubecfg }} -n {{ app_namespace }} delete secret admin-user-secrets
