---
#########################################################################
# Creates a standardized 'admin' user for the Combine through the
# following tasks:
#  - Stop all running containers
#  - start the backend container with the following additional environment
#    variables defined:
#      * COMBINE_ADMIN_USERNAME
#      * COMBINE_ADMIN_PASSWORD
#      * COMBINE_ADMIN_EMAIL
#    Note that 'docker-compose' will start the database service as well
#    since the backend depends on it
#  - start the Combine back up
#########################################################################

- name: stop running containers
  command: docker-compose down
  args:
    chdir: "{{ combine_app_dir }}"

- name: run backend to create admin user
  command:
    "docker-compose run -e COMBINE_ADMIN_USERNAME=\"{{ combine_admin_username }}\" \
    -e COMBINE_ADMIN_PASSWORD=\"{{ combine_admin_password }}\" \
    -e COMBINE_ADMIN_EMAIL=\"{{ combine_admin_email }}\" backend"
  args:
    chdir: "{{ combine_app_dir }}"

- name: startup TheCombine
  command: docker-compose up --detach
  args:
    chdir: "{{ combine_app_dir }}"
