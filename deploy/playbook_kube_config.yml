---
##############################################################
# Playbook: playbook_setup_target.yml
#
# playbook_setup_target.yml installs the packages and
# configuration files that are required to run TheCombine
# as a collection of Docker containers.
#
##############################################################

- name: Setup TheCombine Using Docker
  hosts: server,qa,nuc
  gather_facts: yes
  become: yes

  vars_files:
    - "vars/config_common.yml"
    - "vars/packages.yml"
    - "vars/vault_config.yml"
    # The aws_credentials allows us to use a different vault file to specify the
    # AWS credentials while testing.  By default, vars/aws.yml is used.  To
    # use a different file, such as _test_aws.yml, add the following to your
    # ansible-playbook command:
    #   -e "aws_credentials=_test_aws.yml"
    - "vars/{{ aws_credentials | default('aws.yml',true) }}"

  tasks:
    - name: Setup Kubernetes access from localhost
      block:
        - name: Get kubeconfig for microk8s
          command: microk8s config
          register: kubeconfig

        - name: Setup local kubectl configuration
          delegate_to: localhost
          become: no
          block:
            - name: Create directory for kubectl configurations
              file:
                path: "{{ k8s_working_dir }}"
                state: directory
                mode: 0700

            - name: Save kubeconfig for this device
              copy:
                content: "{{ kubeconfig.stdout }}"
                dest: "{{ k8s_working_dir }}/kubeconfig"
      when:
        - install_microk8s

    - name: Setup registry credentials (Amazon/Docker/Azure/Google)
      import_role:
        name: registry_creds
      when: pull_secrets_manager == "registry_creds"

    - name: Create Kubernetes Configuration Files
      import_role:
        name: k8s_config
