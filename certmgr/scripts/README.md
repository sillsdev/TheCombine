# Design notes for the certbot container for TheCombine

## Certificate storage

The certificates are stored in a docker volume.  The volume is named letsencrypt
and is mounted by the `frontend` and the `certmgr` containers.  Both containers mount
the volume at `/etc/letsencrypt`.

At the top level, there are 3 directories in `/etc/letsencrypt`:
 - `letsencrypt` - stores the certificates created by letsencrypt and managed by `certbot`.
   `/etc/letsencrypt` is created as a symbolic link to `/etc/letsencrypt/letsencrypt`
 - `nginx` - The Nginx web server is configured to read its SSL certificates from:
   - SSL Certificate: `/etc/letsencrypt/nginx/<server_name>/fullchain.pem`
   - SSL Private Key: `/etc/letsencrypt/nginx/<server_name>/privkey.pem`

   This is implemented by setting up `/etc/letsencrypt/nginx/ssl/<server_name>` as a
   symbolic link to the self-signed or letsencrypt certificates.
 - `selfsigned` - stores a self-signed certificate for the server in
   `/etc/letsencrypt/selfsigned/<server_name>`

## Entrypoint scripts for the certbot container for TheCombine

### self-signed.sh
Creates a self-signed certificate to be used by the nginx web server and exits.

#### Environment Variables

| Variable Name       | Description                                                                  |
| ------------------- | ---------------------------------------------------------------------------- |
| CERT_STORE           | Directory for the SSL certificates                                           |
| CERT_CLEAN          | Set to 1 to remove old certificates first                                    |
| CERT_PRIMARY_DOMAIN | Primary domain for the certificate - used to specify location of certificate |
|                     |                                                                              |

### letsencrypt.sh
Uses certbot to create/renew a certificate for the nginx web server.  If there are
no certificates or if the certificate is for `localhost` then the certificates will
be deleted and a certificate will be generated by `letsencrypt`.  `letsencrypt`
will then enter a loop to check for certificate renewal every 12 hours.

#### Environment Variables

| Variable Name     | Description                                      |
| ----------------- | ------------------------------------------------ |
| CERT_STORE         | Directory for the SSL certificates               |
| CERT_STAGING      | Set to 1 to generate a testing certificate       |
| CERT_DOMAINS      | List of domains for the certificate              |
| CERT_KEY_SIZE     | Size for the RSA Key (Optional: default is 4096) |
| CERT_EMAIL        | Support email for the certificate                |
| FORCE             | Delete any existing certificates first           |
| EXIT_AFTER_CREATE | Exit after creating the certificates             |

### certserver.sh
*Not Implemented Yet*

creates multiple certificates and pushes them to an AWS S3 bucket

### certclient.sh
*Not Implemented Yet*

fetches an SSL certificate from the AWS S3 bucket (when an internet connection is
available)

## Installation Requirements

The following scenarios list the various requirements for the Ansible playbook that
is used to setup the various targets, `playbook_target_setup.yml` and the Python
script that is used to setup the development environment, `docker_setup.py`.  `docker_setup.py`
is only used for setting up a development environment that uses a self-signed
certificate.

For each scenario, the first step is to build each of the containers and then run
the appropriate script.

The sections below list the steps that must be performed for each of the installation
scenarios.

### Self-Signed Certificates
When installing TheCombine for using self-signed certificates, e.g. for the QA server
or for development use, the following steps are required:
  1. Build each container:
     - frontend
     - backend
     - certbot
  2. Install & configure the docker files:
     1. for Linux server (e.g. QA server) run the Ansible script, `playbook_target_setup.yml`
     2. for Development mode, run `docker_setup.py`
  3. Run `docker-compose up --detach`

### Let's Encrypt Certificates
When installing TheCombine for using certificates from letsencrypt, e.g. for the
Live server, the following steps are required:
  1. Build each container:
     - frontend
     - backend
     - certbot
  2. Install & configure the docker files: run the `playbook_target_setup.yml` playbook;  The Playbook will
     1.
  3. Create a dummy, self-signed certificate: run `docker-compose run --rm --entrypoint "selfsigned.sh" certbot`
  4. Start up the frontend: run `docker-compose up --force-recreate -d frontend`
  5. Start the certbot container to get a certificate from letsencrypt: run `docker-compose run --rm -e CERT_CLEAN=1 --entrypoint "letsencrypt.sh" certbot`
  6. Reload the nginx configuration: run `docker-compose exec frontend nginx -s reload` (may not be necessary since certificates are in the same location)
  7. Run TheCombine: `docker-compose up --detach`
