name: "Combine Build"
description: "Build Docker images for The Combine and push to AWS ECR"
inputs:
  image_repo:
    description: "Docker Image Repository"
    required: true
  aws_access_key_id:
    description: "Access key id for AWS ECR - must have read/write access"
    required: true
  aws_secret_access_key:
    description: "Password token for aws_access_key_id"
    required: true
  aws_default_region:
    description: "Default accessibility zone for AWS ECR images"
    required: true
outputs:
  image_tag:
    description: "Image Tag for docker images"
    value: ${{ steps.save_image_tag.outputs.image_tag }}
runs:
  using: "composite"
  steps:
    - name: Create Image Tag
      run: |
        echo "IMAGE_TAG="`deploy/scripts/app_release.py --get` >> $GITHUB_ENV
      shell: bash

    - name: Save Image Tag
      id: save_image_tag
      run: echo "::set-output name=image_tag::${{ env.IMAGE_TAG }}"
      shell: bash

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ inputs.aws_access_key_id }}
        aws-secret-access-key: ${{ inputs.aws_secret_access_key }}
        aws-region: ${{ inputs.aws_default_region }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build The Combine
      run: |
        deploy/scripts/build.py --tag ${{ env.IMAGE_TAG }} --repo ${{ inputs.image_repo }}
      shell: bash
